# 성능 테스트 시나리오 — 이커머스 (오케스트레이션 SAGA + 분산락)

현재 구현(오케스트레이션 기반 SAGA + 분산락 `@CommonLock`)을 기준으로, **핵심 API** 대상의 성능 테스트를 진행합니다.  
실행 환경은 로컬(Localhost)이며, 단순 검증 목적이므로 **부하·내구성·스트레스·최고 부하 테스트**만 정의합니다.

---

## 1) 대상 API

### A. 계좌/포인트
- **충전**: `POST /api/v1/accounts/charge` — { userId, amount }  
  → `@CommonLock("account:#userId")` 적용, Account + AccountHistory 저장
- **조회**: `GET /api/v1/accounts/{userId}` — 잔액 조회 (read-only)

### B. 주문/결제
- **주문 생성 & 결제**: `POST /api/v1/orders`  
  (재고 차감 → 주문 저장 → 결제 → 쿠폰 확정 → Outbox 저장)

---

## 2) 목적 (SLO/운영 관점)

- **포인트 조회**: p95 < 300ms
- **포인트 충전**: p95 < 800ms, 에러율 < 1%
- **주문/결제**: p95 < 1200ms, 에러율 < 1.5%
- **정합성**: 동시성 충돌(같은 userId/couponId/itemId)에서도 **정합성 실패 0건** 보장

---

## 3) 데이터 준비

- 사용자: 200명 (userId: 1000~1199)
- 아이템: 일부는 **핫 아이템**으로 지정
- 계좌 잔액: 충분/부족 혼합
- 쿠폰: 일부는 중복/사용됨 상태

---

## 4) 테스트 유형

### 4.1 **부하 테스트 (Load Test)**
- 목적: 운영 목표 구간에서 성능 검증
- 시나리오: 200 RPS, 1분간 지속
- 기대값:
    - 충전 p95 < 800ms
    - 주문/결제 p95 < 1200ms
    - 에러율 < 1%

---

### 4.2 **내구성 테스트 (Endurance Test)**
- 목적: 장시간 안정성/메모리 누수/락 경합 확인
- 시나리오: 50 RPS, 30분간 지속
- 기대값:
    - 지연시간 안정적 유지 (p95 < 1000ms)
    - 에러율 < 1%
    - GC/메모리/락 실패 증가 없음

---

### 4.3 **스트레스 테스트 (Stress Test)**
- 목적: 점진적 램핑으로 **시스템 한계치** 확인
- 시나리오: 50 → 400 RPS, 단계별 1분씩 증가
- 기대값:
    - 어느 시점부터 응답 지연/락 획득 실패 증가하는지 확인
    - 안정 구간/불안정 구간 경계 도출

---

### 4.4 **최고 부하 테스트 (Spike Test)**
- 목적: 순간 폭증 상황에서 회복력 확인
- 시나리오: 200 RPS 운영 중, 순간적으로 500 RPS(15초) 폭주
- 기대값:
    - 순간 지연/에러 증가 후에도 정상 회복
    - 데이터 정합성 보장 (잔액/재고/쿠폰)

---

## 5) 측정/임계치 (k6 Thresholds 예시)

| 항목 | 임계치 |
|---|---|
| http_req_failed | rate < 0.01 (주문은 < 0.015) |
| 포인트 조회 | p95 < 300ms |
| 포인트 충전 | p95 < 800ms |
| 주문/결제 | p95 < 1200ms |
| 정합성 오류 | 0 건 |

---

## 6) 관찰 포인트

- **분산락**: `@CommonLock('account:#userId')`, `@CommonLock('userCoupon:couponId,userId')` 경합/대기시간
- **재고 차감**: itemId 정렬에도 불구하고 핫 아이템 집중 시 락 체인 발생 여부
- **Outbox**: I/O 부하 및 재시도 동작
- **DB 풀/쿼리**: 인덱스 적정성, Connection Pool 대기 발생 여부
- **스레드풀**: 톰캣/Executor 큐 적체  
